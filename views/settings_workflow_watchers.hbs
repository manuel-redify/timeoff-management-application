{{> header }}

<h1>Watcher Rules</h1>

<p class="lead">Configure who should be notified when leave is requested, approved, or cancelled.</p>

{{> show_flash_messages }}

<div class="row">
    <div class="col-md-3">
        <div class="list-group">
            <a href="/settings/workflow/" class="list-group-item">General Org Entities</a>
            <a href="/settings/workflow/rules/" class="list-group-item">Approval Rules</a>
            <a href="/settings/workflow/watchers/" class="list-group-item active">Watcher Rules</a>
        </div>
    </div>

    <div class="col-md-9">

        <div class="panel panel-default">
            <div class="panel-heading">Active Watchers</div>
            <div class="panel-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Project Type</th>
                            <th>Contract Type</th>
                            <th>Watcher (Role)</th>
                            <th>Watcher (Team)</th>
                            <th>Watcher (Project)</th>
                            <th>Team Scope</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each rules}}
                        <tr>
                            <td>{{this.project_type}}</td>
                            <td>{{this.contract_type}}</td>
                            <td>{{this.role.name}}</td>
                            <td>{{this.team.name}}</td>
                            <td>{{this.project.name}}</td>
                            <td>{{#if this.team_scope_required}}<span class="label label-warning">Team</span>{{/if}}
                            </td>
                            <td>
                                <button type="button" class="btn btn-link btn-xs" data-toggle="modal"
                                    data-target="#edit_watcher_modal" data-id="{{this.id}}"
                                    data-project_type="{{this.project_type}}"
                                    data-contract_type="{{this.contract_type}}" data-role_id="{{this.role.id}}"
                                    data-team_id="{{this.team.id}}" data-project_id="{{this.project.id}}"
                                    data-team_scope_required="{{this.team_scope_required}}" title="Edit"><i
                                        class="fa fa-pencil"></i></button>
                                <form method="POST" action="/settings/workflow/watchers/delete/" style="display:inline">
                                    <input type="hidden" name="id" value="{{this.id}}">
                                    <button type="submit" class="btn btn-link btn-xs text-danger" title="Remove"><i
                                            class="fa fa-remove"></i></button>
                                </form>
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel panel-info">
            <div class="panel-heading">Create New Watcher Rule</div>
            <div class="panel-body">
                <form method="POST" action="/settings/workflow/watchers/add/">
                    <div class="row">
                        <div class="col-md-3">
                            <label>Project Type</label>
                            <select name="project_type" class="form-control" required>
                                <option value="Project">Project</option>
                                <option value="Staff Augmentation">Staff Augmentation</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Requester Contract Type</label>
                            <select name="contract_type" class="form-control">
                                <option value="">Any</option>
                                <option value="Employee">Employee</option>
                                <option value="Contractor">Contractor</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Watch Role</label>
                            <select name="role_id" class="form-control">
                                <option value="">None</option>
                                {{#each roles}}
                                <option value="{{this.id}}">{{this.name}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Watch Team</label>
                            <select name="team_id" class="form-control">
                                <option value="">None</option>
                                {{#each teams}}
                                <option value="{{this.id}}">{{this.name}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Watch Project</label>
                            <select name="project_id" class="form-control">
                                <option value="">None</option>
                                {{#each projects}}
                                <option value="{{this.id}}">{{this.name}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                    <br>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" name="team_scope_required"> Watcher must be in the same Team/Project
                            membership
                        </label>
                    </div>
                    <hr>
                    <button type="submit" class="btn btn-primary">Save Watcher Rule</button>
                </form>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="edit_watcher_modal" tabindex="-1" role="dialog" aria-labelledby="edit_watcher_modal_label">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form method="POST" action="/settings/workflow/watchers/update/" id="edit_watcher_form">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="edit_watcher_modal_label">Edit Watcher Rule</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="edit_watcher_id">

                    <div class="form-group">
                        <label>Project Type</label>
                        <select name="project_type" id="edit_project_type" class="form-control" required>
                            <option value="Project">Project</option>
                            <option value="Staff Augmentation">Staff Augmentation</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Requester Contract Type</label>
                        <select name="contract_type" id="edit_contract_type" class="form-control">
                            <option value="">Any</option>
                            <option value="Employee">Employee</option>
                            <option value="Contractor">Contractor</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Watch Role</label>
                        <select name="role_id" id="edit_role_id" class="form-control">
                            <option value="">None</option>
                            {{#each roles}}
                            <option value="{{this.id}}">{{this.name}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Watch Team</label>
                        <select name="team_id" id="edit_team_id" class="form-control">
                            <option value="">None</option>
                            {{#each teams}}
                            <option value="{{this.id}}">{{this.name}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Watch Project</label>
                        <select name="project_id" id="edit_project_id" class="form-control">
                            <option value="">None</option>
                            {{#each projects}}
                            <option value="{{this.id}}">{{this.name}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <div class="checkbox">
                        <label>
                            <input type="checkbox" name="team_scope_required" id="edit_team_scope_required"> Watcher
                            must be in the same Team/Project membership
                        </label>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        $('#edit_watcher_modal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var id = button.data('id');
            var project_type = button.data('project_type');
            var contract_type = button.data('contract_type');
            var role_id = button.data('role_id');
            var team_id = button.data('team_id');
            var project_id = button.data('project_id');
            var team_scope_required = button.data('team_scope_required');

            var modal = $(this);
            modal.find('#edit_watcher_id').val(id);
            modal.find('#edit_project_type').val(project_type);
            modal.find('#edit_contract_type').val(contract_type);
            modal.find('#edit_role_id').val(role_id || "");
            modal.find('#edit_team_id').val(team_id || "");
            modal.find('#edit_project_id').val(project_id || "");
            modal.find('#edit_team_scope_required').prop('checked', team_scope_required === true || team_scope_required === "true");
        });
    });
</script>

{{> footer }}