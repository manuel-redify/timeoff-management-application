{{> header }}

<h1>Approval Rules</h1>

<p class="lead">Define who must approve leave requests based on the requester's role and project context.</p>

{{> show_flash_messages }}

<div class="row">
    <div class="col-md-3">
        <div class="list-group">
            <a href="/settings/workflow/" class="list-group-item">General Org Entities</a>
            <a href="/settings/workflow/rules/" class="list-group-item active">Approval Rules</a>
            <a href="/settings/workflow/watchers/" class="list-group-item">Watcher Rules</a>
        </div>
    </div>

    <div class="col-md-9">

        <div class="panel panel-default">
            <div class="panel-heading">Active Rules</div>
            <div class="panel-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>If Role is...</th>
                            <th>on project type...</th>
                            <th>approver must be...</th>
                            <th>constraints</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each grouped_rules}}
                        <tr>
                            <td>
                                <strong>{{this.subject_role.name}}</strong>
                                {{#if this.subject_area}}<br><small class="text-muted">Area:
                                    {{this.subject_area.name}}</small>{{/if}}
                            </td>
                            <td>{{this.project_type}}</td>
                            <td>
                                <ul class="list-unstyled">
                                    {{#each this.approvals}}
                                    <li>
                                        <span class="badge">{{this.sequence_order}}</span>
                                        {{this.approver_role.name}}
                                        {{#if this.approver_area_constraint}}<small
                                            class="text-info">({{this.approver_area_constraint}})</small>{{/if}}
                                        {{#if this.team_scope_required}}<small
                                            class="text-warning">[Team]</small>{{/if}}
                                        <button type="button" class="btn btn-link btn-xs" data-toggle="modal"
                                            data-target="#edit_rule_modal" data-id="{{this.id}}"
                                            data-project_type="{{../this.project_type}}"
                                            data-subject_role_id="{{../this.subject_role.id}}"
                                            data-subject_area_id="{{../this.subject_area.id}}"
                                            data-approver_role_id="{{this.approver_role.id}}"
                                            data-approver_area_constraint="{{this.approver_area_constraint}}"
                                            data-team_scope_required="{{this.team_scope_required}}"
                                            data-sequence_order="{{this.sequence_order}}" title="Edit"><i
                                                class="fa fa-pencil"></i></button>
                                        <form method="POST" action="/settings/workflow/rules/delete/"
                                            style="display:inline">
                                            <input type="hidden" name="id" value="{{this.id}}">
                                            <button type="submit" class="btn btn-link btn-xs text-danger"
                                                title="Remove"><i class="fa fa-remove"></i></button>
                                        </form>
                                    </li>
                                    {{/each}}
                                </ul>
                            </td>
                            <td>
                                <a href="#" class="btn btn-default btn-xs">Add Approver</a>
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel panel-info">
            <div class="panel-heading">Create New Rule</div>
            <div class="panel-body">
                <form method="POST" action="/settings/workflow/rules/add/">
                    <div class="row">
                        <div class="col-md-4">
                            <label>Requester Role</label>
                            <select name="subject_role_id" class="form-control">
                                {{#each roles}}
                                <option value="{{this.id}}">{{this.name}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Project Type</label>
                            <select name="project_type" class="form-control">
                                <option value="Project">Project</option>
                                <option value="Staff Augmentation">Staff Augmentation</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Subject Area (Optional)</label>
                            <select name="subject_area_id" class="form-control">
                                <option value="">None</option>
                                {{#each areas}}
                                <option value="{{this.id}}">{{this.name}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-md-4">
                            <label>Approver Role</label>
                            <select name="approver_role_id" class="form-control">
                                {{#each roles}}
                                <option value="{{this.id}}">{{this.name}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Area Constraint</label>
                            <select name="approver_area_constraint" class="form-control">
                                <option value="">None</option>
                                <option value="SAME_AS_SUBJECT">Same as Requester</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Order</label>
                            <input type="number" name="sequence_order" class="form-control" value="1">
                        </div>
                    </div>
                    <br>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" name="team_scope_required"> Approver must be in the same Team/Project
                            membership
                        </label>
                    </div>
                    <hr>
                    <button type="submit" class="btn btn-primary">Save Rule</button>
                </form>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="edit_rule_modal" tabindex="-1" role="dialog" aria-labelledby="edit_rule_modal_label">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form method="POST" action="/settings/workflow/rules/update/" id="edit_rule_form">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="edit_rule_modal_label">Edit Approval Rule</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="edit_rule_id">
                    <input type="hidden" name="project_type" id="edit_project_type">
                    <input type="hidden" name="subject_role_id" id="edit_subject_role_id">
                    <input type="hidden" name="subject_area_id" id="edit_subject_area_id">

                    <div class="form-group">
                        <label>Approver Role</label>
                        <select name="approver_role_id" id="edit_approver_role_id" class="form-control">
                            {{#each roles}}
                            <option value="{{this.id}}">{{this.name}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Area Constraint</label>
                        <select name="approver_area_constraint" id="edit_approver_area_constraint" class="form-control">
                            <option value="">None</option>
                            <option value="SAME_AS_SUBJECT">Same as Requester</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Order</label>
                        <input type="number" name="sequence_order" id="edit_sequence_order" class="form-control">
                    </div>

                    <div class="checkbox">
                        <label>
                            <input type="checkbox" name="team_scope_required" id="edit_team_scope_required"> Approver
                            must be in the same Team/Project membership
                        </label>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        $('#edit_rule_modal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var id = button.data('id');
            var project_type = button.data('project_type');
            var subject_role_id = button.data('subject_role_id');
            var subject_area_id = button.data('subject_area_id');
            var approver_role_id = button.data('approver_role_id');
            var approver_area_constraint = button.data('approver_area_constraint');
            var team_scope_required = button.data('team_scope_required');
            var sequence_order = button.data('sequence_order');

            var modal = $(this);
            modal.find('#edit_rule_id').val(id);
            modal.find('#edit_project_type').val(project_type);
            modal.find('#edit_subject_role_id').val(subject_role_id);
            modal.find('#edit_subject_area_id').val(subject_area_id);

            modal.find('#edit_approver_role_id').val(approver_role_id);
            modal.find('#edit_approver_area_constraint').val(approver_area_constraint);
            modal.find('#edit_sequence_order').val(sequence_order);
            modal.find('#edit_team_scope_required').prop('checked', team_scope_required === true || team_scope_required === "true");
        });
    });
</script>

{{> footer }}